name: Deploy

on:
  push:
    branches: [master, deploy]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Docker setup
        run: |
          sudo chmod 666 /var/run/docker.sock || true
          docker --version

      - name: Pull and rebuild Docker
        run: |
          git pull origin master
          docker stop backend-pulse || true
          docker rm backend-pulse || true
          docker build -t backend-pulse .
          docker run -d -p 8000:8000 --name backend-pulse backend-pulse
          
      - name: Update Django environment
        env:
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          DEBUG: False
          IS_URL: False
          DATABASE_NAME: ${{ vars.DATABASE_NAME }}
          DATABASE_HOST: ${{ vars.DATABASE_HOST }}
          DATABASE_PASSWORD: ${{ vars.DATABASE_PASSWORD }}
        run: |
          echo "${{ secrets.SECRET_KEY }}"
          echo "DEBUG=${DEBUG:?'DEBUG is not set'}"
          echo "IS_URL=${IS_URL:?'IS_URL is not set'}"
          echo "DATABASE_NAME=${DATABASE_NAME:?'DATABASE_NAME is not set'}"
          echo "DATABASE_HOST=${DATABASE_HOST:?'DATABASE_HOST is not set'}"
          echo "DATABASE_PASSWORD=${DATABASE_PASSWORD:?'DATABASE_PASSWORD is not set'}"